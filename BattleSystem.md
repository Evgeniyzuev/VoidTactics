# Документ: Поэтапная разработка новой системы боя

## Введение
Текущая система боя является раундовой и симметричной (две стороны), что ограничивает динамику. Новая система вводит:
- **Реальное время**: Урон и деньги рассчитываются непрерывно, с высокой точностью (используя fixed timestep для детерминизма).
- **Индивидуальные атаки**: Каждый флот выбирает цель независимо, без разделения на стороны. Атаки визуализируются красными мерцающими линиями.
- **Баблы**: Атакующий флот создает статичный бабл, замедляющий движение внутри. Атакованный отвечает без бабла. Флот может пытаться покинуть бабл, если бабл атакующего в кд.
- **Оптимизация**: Использовать пространственные индексы (quadtree) для поиска целей, батчинг урон-расчетов, ограничение количества активных боев.

## Этап 1: Переход к индивидуальным атакам без сторон
1. **Модификация Battle.ts**: Убрать sideA и sideB. Сделать бой индивидуальным: каждый флот в бою атакует свою ближайшую цель, без разделения на стороны.
2. **Обновление Fleet.ts**: Добавить поле `currentTarget: Fleet | null` для текущей цели атаки. Модифицировать логику выбора цели в update().
3. **Визуализация линий атаки**: В draw() добавить рисование красных мерцающих линий от атакующего флота к цели. Использовать alpha-анимацию для мерцания.
4. **Интеграция в AIController.ts**: Адаптировать AI для выбора целей индивидуально, без присоединения к сторонам.

## Этап 2: Реализация расчета урона в реальном времени
1. **Модель урона**: Перейти от strength к детализированной: HP, shields, armor. Урон рассчитывается per-frame (например, 60 FPS), но с накоплением для точности (как accumulatedDamage сейчас, но более детально).
2. **Деньги**: Добавить систему награбления. При уроне атакующий получает деньги пропорционально урону (например, 10% от стоимости корабля цели). Деньги обновляются в реальном времени, без задержек.
3. **Оптимизация**: Использовать fixed timestep (например, 1/60 сек) для урон-расчетов, чтобы избежать зависимости от FPS. Батчинг: рассчитывать урон для групп флотов вместе, используя SIMD если возможно.

## Этап 3: Переработка логики атак и целей
1. **Выбор целей**: Убрать стороны. Каждый флот сканирует ближайших врагов (радиус 1000 ед.) и выбирает ближайшую цель по приоритету (расстояние, фракция, сила).
2. **Логика атаки**: При начале атаки флот создает CombatZone вокруг цели. Атакованный автоматически отвечает, но без своего бабла. Флот в зоне может перестать атаковать и покинуть зону (если бабл в кд).
3. **Переключение целей**: После уничтожения цели флот ищет следующую ближайшую автоматически. Добавить таймеры для предотвращения спама переключений.
4. **AI адаптация**: Модифицировать AIController.ts для новой логики: вместо присоединения к сторонам, индивидуальный выбор целей и реакция на баблы.

## Этап 4: Внедрение баблов и эффектов замедления
1. **Создание бабла**: При атаке флот создает CombatZone с радиусом (например, 500 ед.), внутри которой скорость всех флотов * 0.1. Бабл статичен, не следует за флотом.
2. **Эффекты**: В CombatZone.update() применять замедление к флотам внутри. Атакованный отвечает без бабла, но может использовать свои abilities (bubble для контр-замедления).
3. **Побег из бабла**: Добавить логику: если бабл атакующего в кд (например, 5 сек после создания), флот может покинуть зону, двигаясь наружу.
4. **Визуалы**: Бабл как полупрозрачный круг с эффектами частиц, линии атаки красные, мерцающие (alpha анимация).

## Этап 5: Тестирование и оптимизация производительности
1. **Тестирование**: Создать тестовые сценарии (1v1, 5v5, массовые бои) для проверки баланса, производительности (цель: <10ms/frame при 100+ флотах).
2. **Оптимизация**: Внедрить quadtree для поиска целей (O(log n) вместо O(n^2)). Лимит активных зон (например, 50 одновременно). Профилирование с Chrome DevTools.
3. **Баланс**: Настроить урон, баблы, деньги через конфиг-файлы, не хардкод.

## Этап 6: Интеграция с UI и экономикой
1. **UI обновления**: В UIManager.ts добавить индикаторы баблов, линий атаки. Показывать деньги в реальном времени.
2. **Экономика**: Интегрировать с инвентарем (Stage 3 Roadmap). Деньги от боев влияют на покупку топлива/поставок.
3. **Сохранение**: Обновить SaveSystem.ts для хранения баблов и активных боев.

## Риски и mitigation
- **Производительность**: Раннее профилирование, лимиты на зоны/флоты.
- **Баланс**: Итеративное тестирование, метрики (средняя продолжительность боя, экономика).
- **Регрессии**: Постепенная миграция, флаги для старой/новой системы.
